<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Forecast - {{ forecast.city_name }}</title>
    <link rel='stylesheet' href='/static/styles/style.css'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class='forecast-container'>
        <h1>5-Day Forecast for <strong>{{ forecast.city_name }}</strong></h1>

        {% if forecast.forecast %}
        <canvas id='forecastChart' width='1000' height='450'></canvas>

        <script>
            const ctx = document.getElementById('forecastChart').getContext('2d');
        
            const labels = [
                {% for entry in forecast.forecast %}
                    '{{ entry.date_time.strftime("%d %b %H:%M") }}',
                {% endfor %}
            ];
        
            const temperatures = [
                {% for entry in forecast.forecast %}
                    {{ entry.temperature }},
                {% endfor %}
            ];
        
            const iconUrls = [
                {% for entry in forecast.forecast %}
                    '{{ entry.icon_url }}',
                {% endfor %}
            ];
        
            const images = iconUrls.map(url => {
                const img = new Image();
                img.src = url;
                return img;
            });
        
            function getPointColor(temp) {
                if (temp <= 0) {
                    return '#00BFFF';
                } else if (temp <= 15) {
                    return '#ADD8E6';
                } else if (temp <= 25) {
                    return '#FF8C00';
                } else {
                    return '#B22222';
                }
            }
        
            const forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: temperatures,
                        fill: false,
                        borderColor: 'white',
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: temperatures.map(temp => getPointColor(temp)),
                        pointBorderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    layout: {
                        padding: {
                            left: 20,
                            right: 20,
                            top: 20,
                            bottom: 20
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time',
                                color: 'orange',
                                font: {
                                    size: 20
                                }
                            },
                            ticks: {
                                maxRotation: 90,
                                minRotation: 45,
                                color: 'white',
                                font: {
                                    size: 16
                                }
                            },
                            grid: {
                                color: 'orange',
                                linewidth: 0.5
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature (°C)',
                                color: 'orange',
                                font: {
                                    size: 20
                                }
                            },
                            ticks: {
                                color: 'white',
                                font: {
                                    size: 16
                                }
                            },
                            grid: {
                                color: 'orange',
                                linewidth: 0.5
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                },
                plugins: [
                    {
                        id: 'weatherIcons',
                        afterDatasetsDraw(chart) {
                            const {ctx} = chart;
                            const meta = chart.getDatasetMeta(0);
        
                            meta.data.forEach((point, index) => {
                                const x = point.x;
                                const y = point.y;
                                const image = images[index];
        
                                if (image.complete) {
                                    ctx.drawImage(image, x - 15, y - 40, 30, 30);
                                }
                            });
                        }
                    }
                ]
            });
        </script>    

        {% else %}
            <p>No forecast data available.</p>
        {% endif %}
    </div>
</body>
</html>
